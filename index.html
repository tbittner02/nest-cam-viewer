<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NestView Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Archivo+Black&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  :root {
    --bg: #0e0e0f;
    --surface: #1a1a1c;
    --surface2: #222224;
    --border: #2c2c2e;
    --accent: #34d399;
    --accent-dim: #1a3d2e;
    --accent2: #60a5fa;
    --accent2-dim: #1a2a3d;
    --red: #f87171;
    --yellow: #fbbf24;
    --text: #f0f0f0;
    --muted: #666;
    --live: #ef4444;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ── Top bar ── */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1.5rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--surface);
  }
  .logo {
    font-family: 'Archivo Black', sans-serif;
    font-size: 1rem;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .logo-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--live); box-shadow: 0 0 6px var(--live);
    animation: pulse 2s infinite;
  }
  .topbar-right { display: flex; align-items: center; gap: 0.75rem; }
  #status-badge {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.25rem 0.6rem; border-radius: 999px;
    background: var(--bg); border: 1px solid var(--border);
    font-size: 0.65rem; transition: all 0.3s;
  }
  #status-badge.ok { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
  #status-badge.err { border-color: var(--red); color: var(--red); }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
  .btn {
    background: var(--accent); color: #000; border: none;
    padding: 0.65rem 1.5rem; font-family: 'DM Mono', monospace;
    font-weight: 500; font-size: 0.82rem; cursor: pointer;
    border-radius: 2px; transition: opacity 0.2s;
    text-decoration: none; display: inline-block;
  }
  .btn:hover { opacity: 0.85; }
  .btn-ghost {
    background: transparent; color: var(--text);
    border: 1px solid var(--border); padding: 0.25rem 0.7rem;
    font-size: 0.65rem;
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  /* ── Dashboard ribbon ── */
  #dashboard {
    display: flex;
    justify-content: center;
    align-items: stretch;
    gap: 0;
    background: var(--border);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .dash-panel {
    background: var(--surface);
    padding: 0.75rem 1.2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-right: 1px solid var(--border);
  }
  .dash-panel:last-child { border-right: none; }

  /* Clock panel */
  .clock-panel {
    align-items: center;
    min-width: 0;
  }
  #big-clock {
    font-family: 'Orbitron', monospace;
    font-size: 2.2rem;
    font-weight: 900;
    color: var(--accent);
    letter-spacing: 0.05em;
    line-height: 1;
    text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);
    white-space: nowrap;
  }
  #big-ampm {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    opacity: 0.7;
    letter-spacing: 0.1em;
    margin-top: 0.2rem;
    text-align: center;
  }
  #big-date {
    font-size: 0.62rem;
    color: var(--muted);
    margin-top: 0.25rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  /* Calendar panel */
  .calendar-panel {
    align-items: center;
    min-width: 0;
  }
  .cal-month {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 0.35rem;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    font-size: 0.58rem;
  }
  .cal-day-header {
    text-align: center;
    color: var(--muted);
    padding: 2px 0;
    font-size: 0.54rem;
  }
  .cal-day {
    text-align: center;
    padding: 2px 3px;
    border-radius: 2px;
    cursor: default;
    color: var(--text);
    opacity: 0.6;
  }
  .cal-day.today {
    background: var(--accent);
    color: #000;
    font-weight: 700;
    opacity: 1;
  }
  .cal-day.empty { opacity: 0; }

  /* Weather panel */
  .weather-panel {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    padding: 0;
    gap: 0;
  }
  .wx-current {
    padding: 0.75rem 1.2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-right: 1px solid var(--border);
    min-width: 120px;
  }
  .wx-label {
    font-size: 0.55rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.25rem;
  }
  .wx-temp {
    font-family: 'Orbitron', monospace;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--accent2);
    line-height: 1;
  }
  .wx-condition {
    font-size: 0.62rem;
    color: var(--muted);
    margin-top: 0.25rem;
  }

  /* Single combined forecast box */
  .wx-forecasts {
    padding: 0.6rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 0;
    min-width: 220px;
  }
  .wx-forecast-row {
    display: flex;
    align-items: baseline;
    gap: 0.6rem;
    padding: 0.2rem 0;
    border-bottom: 1px solid var(--border);
  }
  .wx-forecast-row:last-child { border-bottom: none; }
  .wx-period {
    font-size: 0.55rem;
    color: var(--accent2);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    min-width: 32px;
    flex-shrink: 0;
  }
  .wx-desc {
    font-size: 0.65rem;
    color: var(--text);
    line-height: 1.4;
    opacity: 0.85;
  }
  .wx-detail {
    font-size: 0.6rem;
    color: var(--muted);
    margin-left: auto;
    flex-shrink: 0;
    white-space: nowrap;
  }

  @media (max-width: 900px) {
    #dashboard { flex-wrap: wrap; justify-content: flex-start; }
    .dash-panel { border-bottom: 1px solid var(--border); }
  }

  /* ── Auth / device picker ── */
  #auth-screen {
    flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 1.5rem; padding: 2rem; text-align: center;
  }
  #auth-screen h2 { font-family: 'Archivo Black', sans-serif; font-size: 1.8rem; }
  #auth-screen p { color: var(--muted); font-size: 0.8rem; max-width: 380px; line-height: 1.7; }

  #device-screen {
    flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 1.5rem; padding: 2rem;
  }
  #device-screen h2 { font-family: 'Archivo Black', sans-serif; font-size: 1.4rem; }
  .device-list { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; max-width: 460px; }
  .device-item {
    background: var(--surface); border: 1px solid var(--border);
    padding: 0.9rem 1.1rem; cursor: pointer; border-radius: 2px;
    display: flex; align-items: center; justify-content: space-between;
    transition: border-color 0.2s; font-size: 0.82rem;
  }
  .device-item:hover { border-color: var(--accent); }
  .device-item.selected { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); }
  .device-name { font-weight: 500; }
  .device-type { font-size: 0.68rem; color: var(--muted); margin-top: 0.2rem; }
  .checkmark { color: var(--accent); opacity: 0; transition: opacity 0.2s; }
  .device-item.selected .checkmark { opacity: 1; }
  .device-hint { font-size: 0.72rem; color: var(--muted); }

  /* ── Viewer ── */
  #viewer-screen {
    flex: 1; display: flex; flex-direction: column;
    min-height: 0; padding: 0.75rem 1rem 1rem; gap: 0.75rem;
  }
  .cams-grid {
    flex: 1; display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem; min-height: 0;
  }
  @media (max-width: 640px) { .cams-grid { grid-template-columns: 1fr; } }

  .cam-cell {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 2px; display: flex; flex-direction: column;
    min-height: 0; overflow: hidden;
  }
  .cam-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.5rem 0.8rem; border-bottom: 1px solid var(--border);
    flex-shrink: 0; font-size: 0.68rem;
  }
  .cam-title { font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
  .live-pill {
    background: var(--live); color: #fff; font-size: 0.55rem;
    padding: 0.1rem 0.4rem; border-radius: 999px; letter-spacing: 0.08em; font-weight: 500;
  }
  .cam-meta { color: var(--muted); font-size: 0.65rem; display: flex; align-items: center; gap: 0.75rem; }
  .cam-fresh {
    font-size: 0.62rem;
    color: var(--accent);
    transition: color 0.5s;
  }
  .cam-fresh.stale { color: var(--yellow); }
  .cam-fresh.frozen { color: var(--red); }

  .cam-body {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative; min-height: 0; background: #000;
  }
  .cam-body video { width: 100%; height: 100%; object-fit: contain; display: block; }
  .cam-overlay {
    position: absolute; inset: 0; display: flex; align-items: center;
    justify-content: center; flex-direction: column; gap: 0.75rem;
    background: rgba(0,0,0,0.85); font-size: 0.78rem; color: var(--muted);
    text-align: center; padding: 1rem; transition: opacity 0.5s;
  }
  .cam-overlay.hidden { opacity: 0; pointer-events: none; }
  .spinner {
    width: 22px; height: 22px; border: 2px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .refresh-bar {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 0.65rem; color: var(--muted); flex-shrink: 0;
  }
  .refresh-track {
    flex: 1; height: 2px; background: var(--border);
    border-radius: 999px; overflow: hidden; margin: 0 1rem;
  }
  .refresh-fill { height: 100%; background: var(--accent); border-radius: 999px; transition: width 1s linear; }

  .hidden { display: none !important; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 6px var(--live)}50%{opacity:.4;box-shadow:none} }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="logo"><div class="logo-dot"></div>NestView</div>
  <div class="topbar-right">
    <div id="status-badge"><div class="status-dot"></div><span id="status-text">checking...</span></div>
    <button class="btn btn-ghost hidden" id="settings-btn" onclick="resetToDevicePicker()">⚙ cameras</button>
  </div>
</div>

<!-- Dashboard ribbon -->
<div id="dashboard">

  <!-- Clock -->
  <div class="dash-panel clock-panel">
    <div id="big-clock">00:00:00</div>
    <div id="big-ampm">AM</div>
    <div id="big-date">Loading...</div>
  </div>

  <!-- Calendar -->
  <div class="dash-panel calendar-panel">
    <div class="cal-month" id="cal-month">February 2026</div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <!-- Weather -->
  <div class="dash-panel weather-panel">
    <div class="wx-current">
      <div class="wx-label">Toronto · Now</div>
      <div class="wx-temp" id="wx-temp">3°C</div>
      <div class="wx-condition" id="wx-condition">Mostly Cloudy</div>
    </div>
    <div class="wx-forecasts">
      <div class="wx-forecast-row" id="wx-6h">
        <div class="wx-period">6h</div>
        <div class="wx-desc">Loading...</div>
      </div>
      <div class="wx-forecast-row" id="wx-12h">
        <div class="wx-period">12h</div>
        <div class="wx-desc">Loading...</div>
      </div>
      <div class="wx-forecast-row" id="wx-24h">
        <div class="wx-period">24h</div>
        <div class="wx-desc">Loading...</div>
      </div>
    </div>
  </div>

</div>

<!-- Auth -->
<div id="auth-screen">
  <h2>Connect Google Home</h2>
  <p>Sign in with the Google account that owns your Nest cameras.</p>
  <a href="/auth" class="btn">Connect with Google →</a>
</div>

<!-- Device picker -->
<div id="device-screen" class="hidden">
  <h2>Select Two Cameras</h2>
  <p class="device-hint">Click to select — choose exactly 2</p>
  <div class="device-list" id="device-list"></div>
  <button class="btn hidden" id="start-btn" onclick="startViewer()">Start Viewing →</button>
</div>

<!-- Viewer -->
<div id="viewer-screen" class="hidden">
  <div class="cams-grid">
    <div class="cam-cell">
      <div class="cam-header">
        <div class="cam-title"><span class="live-pill">LIVE</span><span id="cam-0-title">Camera 1</span></div>
        <div class="cam-meta">
          <span class="cam-fresh" id="cam-0-fresh"></span>
          <span id="cam-0-meta">connecting...</span>
        </div>
      </div>
      <div class="cam-body">
        <div class="cam-overlay" id="cam-0-overlay"><div class="spinner"></div><span id="cam-0-status">Starting stream...</span></div>
        <video id="cam-0-video" autoplay muted playsinline></video>
      </div>
    </div>
    <div class="cam-cell">
      <div class="cam-header">
        <div class="cam-title"><span class="live-pill">LIVE</span><span id="cam-1-title">Camera 2</span></div>
        <div class="cam-meta">
          <span class="cam-fresh" id="cam-1-fresh"></span>
          <span id="cam-1-meta">connecting...</span>
        </div>
      </div>
      <div class="cam-body">
        <div class="cam-overlay" id="cam-1-overlay"><div class="spinner"></div><span id="cam-1-status">Starting stream...</span></div>
        <video id="cam-1-video" autoplay muted playsinline></video>
      </div>
    </div>
  </div>
  <div class="refresh-bar">
    <span>stream refresh</span>
    <div class="refresh-track"><div class="refresh-fill" id="refresh-fill" style="width:100%"></div></div>
    <span id="refresh-countdown">4:50</span>
  </div>
</div>

<script>
// ── Weather data (fetched at page load via server, hardcoded fallback) ─────
// We use the Open-Meteo free API — no key needed
const LAT = 43.6532, LON = -79.3832;

async function loadWeather() {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
      `&current=temperature_2m,weathercode,apparent_temperature` +
      `&hourly=temperature_2m,weathercode,precipitation_probability` +
      `&temperature_unit=celsius&wind_speed_unit=kmh&timezone=America%2FToronto&forecast_days=2`;

    const data = await fetch(url).then(r => r.json());
    const cur = data.current;
    const hourly = data.hourly;

    // Current
    document.getElementById('wx-temp').textContent = Math.round(cur.temperature_2m) + "°C";
    document.getElementById('wx-condition').textContent = wmoDescription(cur.weathercode);

    // Find current hour index
    const now = new Date();
    const curHour = hourly.time.findIndex(t => new Date(t) >= now);
    const idx = curHour < 0 ? 0 : curHour;

    // Build forecast summaries
    setForecast('wx-6h', hourly, idx, idx + 6);
    setForecast('wx-12h', hourly, idx, idx + 12);
    setForecast('wx-24h', hourly, idx, idx + 24);

  } catch(e) {
    console.warn('Weather fetch failed:', e);
    // Fallback to known current conditions
    document.getElementById('wx-temp').textContent = '3°C';
    document.getElementById('wx-condition').textContent = 'Mostly Cloudy';
    document.getElementById('wx-6h').innerHTML = '<div class="wx-period">Next 6h</div><div class="wx-desc">Cloudy, cold. High near 3°C.</div>';
    document.getElementById('wx-12h').innerHTML = '<div class="wx-period">Next 12h</div><div class="wx-desc">Continued overcast. Temps stay cold around 2–4°C.</div>';
    document.getElementById('wx-24h').innerHTML = '<div class="wx-period">Next 24h</div><div class="wx-desc">Overnight into tomorrow: colder, possible flurries. Low ~-2°C.</div>';
  }
}

function setForecast(elId, hourly, fromIdx, toIdx) {
  const end = Math.min(toIdx, hourly.time.length - 1);
  const temps = hourly.temperature_2m.slice(fromIdx, end).map(Math.round);
  const precip = hourly.precipitation_probability.slice(fromIdx, end);
  const codes = hourly.weathercode.slice(fromIdx, end);

  const minT = Math.min(...temps), maxT = Math.max(...temps);
  const maxPrecip = Math.max(...precip);
  const modeCode = codes.sort((a,b) =>
    codes.filter(v=>v===b).length - codes.filter(v=>v===a).length)[0];

  const desc = wmoDescription(modeCode);
  const precipText = maxPrecip >= 30 ? ` · ${maxPrecip}% precip` : '';

  const el = document.getElementById(elId);
  const period = el.querySelector('.wx-period')?.textContent || '';
  el.innerHTML = `
    <div class="wx-period">${period}</div>
    <div class="wx-desc">${desc}${precipText}</div>
    <div class="wx-detail">${minT}°–${maxT}°C</div>
  `;
}

function wmoDescription(code) {
  const map = {
    0:'Clear sky', 1:'Mainly clear', 2:'Partly cloudy', 3:'Overcast',
    45:'Foggy', 48:'Icy fog',
    51:'Light drizzle', 53:'Drizzle', 55:'Heavy drizzle',
    61:'Light rain', 63:'Rain', 65:'Heavy rain',
    71:'Light snow', 73:'Snow', 75:'Heavy snow', 77:'Snow grains',
    80:'Rain showers', 81:'Showers', 82:'Heavy showers',
    85:'Snow showers', 86:'Heavy snow showers',
    95:'Thunderstorm', 96:'Thunderstorm w/ hail', 99:'Thunderstorm w/ heavy hail',
  };
  return map[code] || 'Variable conditions';
}

// ── Clock ──────────────────────────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  let h = now.getHours();
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  const m = String(now.getMinutes()).padStart(2,'0');
  document.getElementById('big-clock').textContent = `${h}:${m}`;
  document.getElementById('big-ampm').textContent = ampm;

  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('big-date').textContent =
    `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
}

// ── Calendar ───────────────────────────────────────────────────────────────
function buildCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();

  const months = ['January','February','March','April','May','June',
                  'July','August','September','October','November','December'];
  document.getElementById('cal-month').textContent = `${months[month]} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  // Day headers
  ['S','M','T','W','T','F','S'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-day-header';
    el.textContent = d;
    grid.appendChild(el);
  });

  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    const el = document.createElement('div');
    el.className = 'cal-day empty';
    grid.appendChild(el);
  }

  // Days
  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement('div');
    el.className = 'cal-day' + (d === today ? ' today' : '');
    el.textContent = d;
    grid.appendChild(el);
  }
}

// ── App state ──────────────────────────────────────────────────────────────
const REFRESH_INTERVAL = 290;
let selectedDevices = [];
let streamData = [null, null];
let hlsPlayers = [null, null];
let countdownInterval = null;
let secondsLeft = REFRESH_INTERVAL;

async function init() {
  updateClock();
  setInterval(updateClock, 1000);
  buildCalendar();
  loadWeather();
  setInterval(loadWeather, 10 * 60 * 1000); // refresh weather every 10 min

  const res = await fetch('/api/status').then(r => r.json());
  if (res.authenticated) {
    setStatus('ok', 'connected');
    if (new URLSearchParams(location.search).get('auth') === 'success') history.replaceState({}, '', '/');
    showDevicePicker();
  } else {
    setStatus('err', 'not connected');
    show('auth-screen');
  }
}

function setStatus(type, text) {
  document.getElementById('status-badge').className = type;
  document.getElementById('status-text').textContent = text;
}

function show(id) {
  ['auth-screen','device-screen','viewer-screen'].forEach(s =>
    document.getElementById(s).classList.toggle('hidden', s !== id));
}

async function showDevicePicker() {
  show('device-screen');
  selectedDevices = [];
  const list = document.getElementById('device-list');
  list.innerHTML = '<div style="color:var(--muted);font-size:0.78rem">Loading cameras...</div>';
  const res = await fetch('/api/devices').then(r => r.json());
  if (!res.devices?.length) {
    list.innerHTML = '<div style="color:var(--red);font-size:0.78rem">No cameras found.</div>';
    return;
  }
  list.innerHTML = '';
  res.devices.forEach(device => {
    const el = document.createElement('div');
    el.className = 'device-item';
    el.innerHTML = `<div><div class="device-name">${device.displayName}</div><div class="device-type">${device.type.replace('sdm.devices.types.','')}</div></div><span class="checkmark">✓</span>`;
    el.addEventListener('click', () => toggleDevice(device, el));
    list.appendChild(el);
  });
}

function toggleDevice(device, el) {
  const idx = selectedDevices.findIndex(d => d.id === device.id);
  if (idx > -1) { selectedDevices.splice(idx, 1); el.classList.remove('selected'); }
  else if (selectedDevices.length < 2) { selectedDevices.push(device); el.classList.add('selected'); }
  document.getElementById('start-btn').classList.toggle('hidden', selectedDevices.length !== 2);
}

function resetToDevicePicker() {
  clearAllTimers(); destroyHlsPlayers(); stopFreshnessTracking(); showDevicePicker();
  document.getElementById('settings-btn').classList.add('hidden');
}

async function startViewer() {
  show('viewer-screen');
  document.getElementById('settings-btn').classList.remove('hidden');
  clearAllTimers(); destroyHlsPlayers();
  for (let i = 0; i < 2; i++) {
    document.getElementById(`cam-${i}-title`).textContent = selectedDevices[i].displayName || `Camera ${i+1}`;
    await loadStream(i);
  }
  startCountdown();
  startFreshnessTracking();
}

async function loadStream(idx) {
  const overlay = document.getElementById(`cam-${idx}-overlay`);
  const statusEl = document.getElementById(`cam-${idx}-status`);
  const meta = document.getElementById(`cam-${idx}-meta`);
  overlay.classList.remove('hidden');
  statusEl.textContent = 'Requesting stream...';
  meta.textContent = 'connecting...';
  try {
    const res = await fetch('/api/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ deviceId: selectedDevices[idx].id, slotId: String(idx) }),
    }).then(r => r.json());
    if (res.error) throw new Error(res.error);
    streamData[idx] = { ...res, hlsUrl: res.hlsUrl };
    statusEl.textContent = 'Buffering video...';
    meta.textContent = 'buffering...';
    attachHls(idx, res.hlsUrl);
  } catch (e) {
    overlay.innerHTML = `<div style="color:var(--red);font-size:0.75rem">Error: ${e.message}</div>`;
    meta.textContent = 'error';
  }
}

function attachHls(idx, hlsUrl) {
  const video = document.getElementById(`cam-${idx}-video`);
  const overlay = document.getElementById(`cam-${idx}-overlay`);
  const meta = document.getElementById(`cam-${idx}-meta`);
  if (hlsPlayers[idx]) { hlsPlayers[idx].destroy(); hlsPlayers[idx] = null; }

  if (Hls.isSupported()) {
    const hls = new Hls({ liveSyncDurationCount: 3, liveMaxLatencyDurationCount: 5 });
    hls.loadSource(hlsUrl);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
    hls.on(Hls.Events.FRAG_BUFFERED, () => { overlay.classList.add('hidden'); meta.textContent = 'live'; });
    hls.on(Hls.Events.ERROR, (e, data) => {
      if (data.fatal) { meta.textContent = 'reconnecting...'; setTimeout(() => attachHls(idx, hlsUrl), 3000); }
    });
    hlsPlayers[idx] = hls;
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = hlsUrl;
    video.addEventListener('loadedmetadata', () => {
      video.play().catch(() => {});
      overlay.classList.add('hidden');
      meta.textContent = 'live';
    });
  } else {
    overlay.innerHTML = '<div style="color:var(--red);font-size:0.75rem">HLS not supported in this browser</div>';
  }
}

function destroyHlsPlayers() {
  hlsPlayers.forEach((p, i) => { if (p) { p.destroy(); hlsPlayers[i] = null; } });
}

// ── Freshness tracker ─────────────────────────────────────────────────────
// Polls the HLS playlist every 3s and tracks when the last new segment arrived
const lastSegmentTime = [null, null]; // timestamp of last new segment per slot
const lastSeenSegment = ['', ''];     // last segment filename seen per slot
let freshnessInterval = null;

function startFreshnessTracking() {
  if (freshnessInterval) clearInterval(freshnessInterval);
  lastSegmentTime[0] = Date.now();
  lastSegmentTime[1] = Date.now();

  freshnessInterval = setInterval(async () => {
    for (let i = 0; i < 2; i++) {
      if (!streamData[i]?.hlsUrl) continue;
      try {
        const res = await fetch(streamData[i].hlsUrl + '?t=' + Date.now());
        const text = await res.text();
        // Extract last .ts segment filename from m3u8
        const segments = text.match(/seg\d+\.ts/g);
        const lastSeg = segments ? segments[segments.length - 1] : null;
        if (lastSeg && lastSeg !== lastSeenSegment[i]) {
          lastSeenSegment[i] = lastSeg;
          lastSegmentTime[i] = Date.now();
        }
      } catch(e) { /* ignore fetch errors */ }

      // Update freshness display
      const el = document.getElementById(`cam-${i}-fresh`);
      if (!el || lastSegmentTime[i] === null) continue;
      const age = Math.round((Date.now() - lastSegmentTime[i]) / 1000);
      el.classList.remove('stale', 'frozen');
      if (age <= 6) {
        const t = new Date(lastSegmentTime[i]);
        let h = t.getHours(), ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        const m = String(t.getMinutes()).padStart(2,'0');
        const s = String(t.getSeconds()).padStart(2,'0');
        el.textContent = `● live · ${h}:${m}:${s} ${ampm}`;
      } else if (age <= 15) {
        el.textContent = `↻ ${age}s ago`;
        el.classList.add('stale');
      } else {
        el.textContent = `⚠ frozen ${age}s`;
        el.classList.add('frozen');
      }
    }
  }, 3000);
}

function stopFreshnessTracking() {
  if (freshnessInterval) clearInterval(freshnessInterval);
  freshnessInterval = null;
  lastSegmentTime[0] = null;
  lastSegmentTime[1] = null;
  lastSeenSegment[0] = '';
  lastSeenSegment[1] = '';
  document.getElementById('cam-0-fresh').textContent = '';
  document.getElementById('cam-1-fresh').textContent = '';
}

function startCountdown() {
  secondsLeft = REFRESH_INTERVAL;
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(async () => {
    secondsLeft--;
    const fill = document.getElementById('refresh-fill');
    const label = document.getElementById('refresh-countdown');
    if (fill) fill.style.width = (secondsLeft / REFRESH_INTERVAL * 100) + '%';
    if (label) {
      const m = Math.floor(secondsLeft / 60);
      label.textContent = `${m}:${String(secondsLeft % 60).padStart(2,'0')}`;
    }
    if (secondsLeft <= 0) {
      setStatus('ok', 'refreshing...');
      for (let i = 0; i < 2; i++) {
        if (!streamData[i]?.streamExtensionToken) continue;
        try {
          const r = await fetch('/api/extend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deviceId: selectedDevices[i].id, streamExtensionToken: streamData[i].streamExtensionToken }),
          }).then(r => r.json());
          if (r.streamExtensionToken) streamData[i].streamExtensionToken = r.streamExtensionToken;
        } catch(e) { console.warn('extend failed', i, e); }
      }
      setStatus('ok', 'connected');
      secondsLeft = REFRESH_INTERVAL;
    }
  }, 1000);
}

function clearAllTimers() {
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = null;
}

init();
</script>
</body>
</html>
